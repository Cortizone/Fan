blueprint:
  name: Gestion de l'humidité jour et nuit pour l'humidificateur Govee H7140
  description: Ajuste la puissance et active/désactive l'humidificateur Govee H7140 en fonction des niveaux d'humidité cibles jour et nuit.
  domain: automation
  input:
    govee_humidifier_power_switch:
      name: Interrupteur de l'humidificateur Govee H7140
      description: Sélectionnez l'interrupteur qui active/désactive l'humidificateur.
      selector:
        entity:
          domain: switch
          entity_id: switch.ch_maitre_humidifier_power_switch
    govee_humidifier_power_level:
      name: Puissance de l'humidificateur Govee H7140
      description: Sélectionnez l'entité qui contrôle la puissance de l'humidificateur.
      selector:
        entity:
          domain: number
          entity_id: number.ch_maitre_humidifier_manual
    humidity_sensor:
      name: Capteur d'humidité
      description: Sélectionnez le capteur d'humidité de la pièce.
      selector:
        entity:
          domain: sensor
    day_time_start:
      name: Début du jour
      description: Heure de début pour le niveau d'humidité de jour.
      default: '08:00'
      selector:
        time: {}
    night_time_start:
      name: Début de la nuit
      description: Heure de début pour le niveau d'humidité de nuit.
      default: '20:00'
      selector:
        time: {}
    day_humidity_target:
      name: Humidité cible de jour (%)
      description: Niveau d'humidité cible pour le jour.
      selector:
        number:
          min: 30
          max: 70
          mode: slider
          step: 1
      default: 40
    night_humidity_target:
      name: Humidité cible de nuit (%)
      description: Niveau d'humidité cible pour la nuit.
      selector:
        number:
          min: 30
          max: 70
          mode: slider
          step: 1
      default: 55

trigger:
  - platform: time_pattern
    minutes: '/5'  # Vérifie toutes les 5 minutes.
  - platform: state
    entity_id: !input "humidity_sensor"

condition: []

action:
  - variables:
      current_time: "{{ now().time() }}"
      day_start: "{{ states('input_datetime.day_time_start') }}"
      night_start: "{{ states('input_datetime.night_time_start') }}"
      humidity_target: >
        {% if day_start <= current_time < night_start %}
          {{ input_number.day_humidity_target }}
        {% else %}
          {{ input_number.night_humidity_target }}
        {% endif %}
  - service: "switch.turn_{{ 'on' if states('sensor.humidity_sensor') | float < humidity_target else 'off' }}"
    entity_id: !input "govee_humidifier_power_switch"
  - service: number.set_value
    target:
      entity_id: !input "govee_humidifier_power_level"
    data:
      value: "{{ [1, ((humidity_target - states('sensor.humidity_sensor') | float) / 5) | round(0), 9] | sort | first }}"
mode: single
