blueprint:
  name: Humidificateur adaptatif (capteur externe)
  description: >-
    Pilote un humidificateur VeSync Classic300S avec un capteur externe. Active
    ou désactive l'humidificateur et règle le niveau de brume selon l'humidité mesurée.
  domain: automation
  input:
    capteur_humidite:
      name: Capteur d'humidité
      description: Capteur d'humidité externe (entité sensor).
      selector:
        entity:
          domain: sensor
    humidificateur:
      name: Humidificateur VeSync
      description: Entité humidificateur VeSync Classic300S.
      selector:
        entity:
          domain: humidifier
    humidite_cible:
      name: Humidité cible (%)
      description: Valeur cible d'humidité relative à maintenir.
      default: 45
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: '%'
    tolerance_basse:
      name: Écart bas (%)
      description: Seuil en-dessous de la cible pour augmenter la vitesse.
      default: 2
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: '%'
    tolerance_haute:
      name: Écart haut (%)
      description: Seuil au-dessus de la cible pour arrêter l'humidificateur.
      default: 5
      selector:
        number:
          min: 0
          max: 100
          unit_of_measurement: '%'
    delai_anti_flapping:
      name: Délai anti-flapping
      description: Durée minimale entre changements d'état pour éviter les oscillations.
      default: 00:05:00
      selector:
        duration: {}
trigger:
  - platform: state
    entity_id: !input capteur_humidite
    # (optionnel : ajouter `for: !input delai_anti_flapping` pour la stabilité)
condition: []
action:
  - variables:
      target: !input humidite_cible
      tol_basse: !input tolerance_basse
      tol_haute: !input tolerance_haute
      diff: "{{ (target | float) - (trigger.to_state.state | float) }}"
  - choose:
      - conditions:
          - "{{ diff >= tol_basse }}"
        sequence:
          - service: humidifier.set_mist_level
            target: !input humidificateur
            data:
              mist_level: 9
      - conditions:
          - "{{ diff > - tol_haute }}"
        sequence:
          - service: humidifier.set_mist_level
            target: !input humidificateur
            data:
              mist_level: 1
      - default:
          - service: humidifier.turn_off
            target: !input humidificateur